# SheetsTalk

![Фото интерфейса](/pic/mainpic.png)

Примитивный зашифрованный чат (текст + голосовые заметки) на `Google Sheets + Google Apps Script Web App`.


## Что делает проект

- Отправляет текст и аудио между участниками одной `room`.
- Шифрует и расшифровывает сообщения только в браузере (`AES-GCM-256`).
- Ключ получается из общего секрета (seed/private key/passphrase) на клиенте.
- Есть мастер настройки: `Создать канал` / `Присоединиться`.
- Есть быстрый invite-flow: копирование invite у создателя и вставка invite у участника.
- Можно запускать интерфейс как встроенный Apps Script UI или как отдельную веб-страницу.
- В отдельном режиме есть кнопка `Настройки` для сохранения URL развертывания Apps Script.
- Для своих сообщений показываются статусы: `Отправляется` -> `Отправлено` -> `Доставлено` -> `Прочитано`.
- В таблице хранится только шифротекст и метаданные.
- Если шифротекст не помещается в ячейку, он сохраняется в `Google Drive`, а в таблицу пишется ссылка-id файла.

## Ограничения

- Это polling-чат, не realtime-звонок.
- Нет identity/signature уровня Signal (нет проверки подмены участника по ключам подписи).
- Безопасность зависит от силы общего секрета и приватности устройства.

## Быстрый запуск (через bound script)

1. Создайте Google Sheet.
2. Откройте `Extensions -> Apps Script`.
3. Создайте/замените файлы:
   - `Code.gs`
   - `Index.html`
4. Сохраните проект.
5. Нажмите `Deploy -> New deployment -> Web app`.
6. Параметры:
   - Execute as: `Me`
   - Who has access: `Anyone with the link` (или уже, если нужно ограничить доступ)
7. Откройте URL web app в браузере.

## Отдельная веб-страница (без встроенного Index в Apps Script)

1. Разместите [Index.html](/Users/t33puck/Documents/Github/SheetsTalk/Index.html) как обычную статическую страницу (например, на Vercel/Netlify/GitHub Pages или локально через Live Server).
2. Откройте страницу.
3. Нажмите `Настройки` и вставьте URL развертывания Apps Script (`.../exec`).
4. URL сохранится в `localStorage` и будет использоваться как backend.

В этом режиме фронтенд общается с Apps Script через API (`?api=1`).

## Почему не получается добавить `appsscript.json`

В Apps Script manifest-файл часто скрыт по умолчанию. Это нормально.

- Вариант 1: ничего не делать. Проект работает и без ручного редактирования manifest.
- Вариант 2: включить показ manifest:
  - `Project Settings -> Show "appsscript.json" manifest file in editor`
  - после этого можно вставить содержимое из `appsscript.json` в этом репозитории.

## Альтернатива: standalone script + конкретная таблица

Если скрипт не bound, передайте ID таблицы в Script Properties:

- В Apps Script: `Project Settings -> Script properties`
- Добавьте `SHEET_ID=<id вашей таблицы>`

## Использование

1. На главном экране мастер предлагает два варианта:
   - `Создать канал`
   - `Присоединиться`
2. Создатель канала:
   - вводит ник;
   - получает автоматически сгенерированные `room` и `seed`;
   - отправляет `room + seed` участникам в доверенном канале.
3. Участник:
   - может вставить быстрый invite (`room + seed`) в отдельное поле;
   - либо вводит `room` и `seed` вручную.
4. После входа:
   - доступен чат текстом и голосовыми (до 30 секунд);
   - есть кнопка `Разрешить микрофон` (запрашивает доступ до записи);
   - создатель продолжает видеть seed канала в интерфейсе чата;
   - в ленте видны системные логи (`N подключился к чату`, `N вышел из чата`);
   - отображается `Fingerprint` для быстрой сверки ключа;
   - для отправленных сообщений есть статусы отправки/доставки/прочтения.

## Формат таблицы

Лист `Messages` создается автоматически с колонками:

- `id`
- `room`
- `createdAt`
- `sender`
- `kind`
- `mime`
- `ivB64`
- `storage` (`INLINE` или `DRIVE`)
- `pointer` (base64 payload или Drive file id)
- `byteLength`

`kind` может быть:
- `text`
- `audio`
- `event` (системные сообщения мастера, например вход/выход пользователей)
- `receipt` (служебные подтверждения доставки/прочтения)

## Рекомендации по безопасности

- Используйте длинный случайный секрет (лучше кнопка `Generate`).
- Передавайте секрет офлайн/в доверенном канале.
- Периодически меняйте `room + secret`.
- Не храните секрет в заметках без шифрования.

## Частые проблемы

- `Не удалось расшифровать (другой ключ/room)`:
  - у участников не совпадает `room` или `Seed / приватный ключ`;
  - сравните `Fingerprint` у всех участников, он должен быть одинаковым.
- `Микрофон: ... request is not allowed ...`:
  - выдан запрет на микрофон для домена web app;
  - нажмите кнопку `Разрешить микрофон` в интерфейсе;
  - если запрет уже сохранен браузером, откройте настройки сайта и вручную включите микрофон;
  - проверьте, что страница открыта по `https`.
- `Permissions policy violation: microphone is not allowed in this document`:
  - страница открыта во встроенном iframe/preview, где микрофон запрещен политикой документа;
  - нажмите `Открыть отдельно` и используйте web app в обычной вкладке браузера (`.../exec`).
- Белая страница после `Открыть отдельно`:
  - обычно это переход на внутренний `userCodeAppPanel` вместо deployment URL;
  - откройте ссылку из `Deploy -> Manage deployments -> Web app URL` (`.../exec`) напрямую;
  - если используется старая кнопка, перезадеплойте последнюю версию кода.

## Отказ от ответственности

Проект поставляется «как есть». Он выложен исключительно в исследовательских и обучающих целях для изучения возможностей Google Apps Script и веб-разработки. Автор не несет ответственности за использование данного проекта.
